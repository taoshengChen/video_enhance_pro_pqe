本文档为PQE（Picture Quality Engine）的硬件特性书。PQE是一个专用于实时视频流处理的硬件加速模块，其核心目标是通过一系列高级图像处理算法，显著提升最终画面的视觉质量。

# 1 特性

1. **核心视频处理与接口**
   *   **灵活的视频流处理：**支持2、4、8个LANE的视频流输入，可灵活适配不同的视频源。<font color=red>（不支持16 LANE视频流输入）</font>
   *   **超高清：**全面兼容1K~4K（宽度介于1920~3840、高度介于1080~2160） ，例如1920x1080、2400x1200、2560x1440、2880x1620、3036x1708、3840x2160
   *   **高帧率：**兼容60Hz~160Hz帧率，例如 60Hz、120Hz 和 <font color=purple>160Hz</font> 帧率，<font color=red>不支持 160Hz 以上</font>
   *   **色彩深度：**支持 **8 比特、10 比特**色深。<font color=red>不支持12比特色深</font>
2. **支持视频整片处理 (Video Slicing):** PQE不支持将单帧画面分割为多个独立的“切片”(Slices)。这意味着如果视频源（如显示控制器）以切片方式提供视频流，必须由上游模块先将切片拼接成完整的一帧，再送入PQE
3. **不包含检测视频链路稳定性的逻辑。**当前的设计假设是：由外部控制器管理视频链路，确保其稳定后，再解除PQE的复位使其开始工作。不稳定的链路信号可能导致PQE输出视觉伪影或产生内部错误。


3. **高级图像增强算法**

   * **自适应饱和度增强：** 

     * **饱和度增强：**智能识别图像内容，采用**自然饱和度**，在提升色彩鲜艳度的同时，避免色彩失真。

        - [x] 可配置饱和度提升（连续）程度

     * **肤色保真：**通过人脸检测和肤色分区，保护人脸区域的色彩，使其在增强的同时保持自然。

       - [x] 可配置的检测模型： 肤色检测的模型参数存储于SRAM

        *   [x] 可开启或关闭肤色检测

   * **细节增强**:

     *   **锐度-清晰度提升：**强化边缘细节，提升画面清晰度。
          - [x] 可开启或关闭降噪
          - [x] 可配置锐化（连续）程度

   * **自适应对比度增强**:

     *   **CLAHE** 算法：显著提升图像暗部细节，让画面层次更丰富。
          - [x] 可开启或关闭HDR自动检测
          - [x] 可配置画面分块数量
          - [x] 可配置时间滤波因子
          - [x] 可配置HDR（连续）程度
     *   **灰阶保护：**内置场景检测机制，可识别纯色/渐变区域，并动态调节HDR等增强算法，以缓解（低）色阶梯度差异。
         - [x] 可配置灰阶范围、灰阶差异、纯色阈值 

   * **图像保护与降噪**:

     *   **引导滤波**算法：自动识别天空等大面积纯色区域，防止图像增强导致的噪声放大。
          - [x] 可开启或关闭降噪
          - [x] 可配置降噪（连续）程度

   * **舒适度提升：**

     *   **护眼色温调节：**降低蓝光，或者调节色温。提供蓝光模式和色温模式，减少长时间观看的视觉疲劳。
          - [x] 可配置色温模式、蓝光模式
          - [x] 可配置色温调节（连续）程度。可配置冷色调和暖色调
          - [x] 可配置蓝光调节（连续）程度

4. **调试功能：**

   *   **分屏对比功能：**可选左右分屏分别配置增强和关闭。可配置左右分屏效果对比，效果可配置为单一算法效果或者叠加算法效果
   *   **纯色图片输出：**支持输出纯色图片，用于调试

5. **通讯与控制**

   *   **初始化：**通过AHB接口进行初始化，及在线参数配置
   *   **中断：** 通过 `intr` 信号向外部控制器报告关键事件。
   *   **视频输入输出**：
       *   **输入接口**：包含 `ide` (数据使能), `ihs` (行同步), `ivs` (场同步), `ick` (像素时钟), 和 `ida` (像素数据) 信号。
       *   **输出接口**：提供 `ode`, `ohs`, `ovs`, `ock`, 和 `oda` 信号，用于将处理后的视频流送至下游模块。

<div STYLE="page-break-after: always;"></div>

# 2 数据流

![](./images/集成框架.png)

这是一个基于**双时钟域**的视频处理系统架构，整个系统由左侧的 **`clk`时钟域**（浅黄色背景）和右侧的 **`pclk`时钟域**（浅橙色背景）组成：

## 2.1 `clk`时钟域（系统控制域）

该区域主要负责系统的控制、配置和视频源选择。

1. **测试视频 (Test Video)：** 用于生成纯色调试信号的视频源模块。
2. **寄存器列表 (REGF)：** 一个大型的核心控制模块，通过标准 AHB 接口与外部控制器连接。
   - **中断接口 (INT Interface)：** 用于向系统控制器发送中断信号。
   - **AHB接口 (AHB Interface)：** 一个标准的AMBA总线接口，用于系统控制器对REGF模块内部的寄存器进行读写配置。
3. **切换视频源 (Video Source Switch)：** 一个关键的数据路径选择器，负责在“正常处理模式”和“调试模式”之间切换视频源。它横跨两个时钟域，但其控制逻辑应属于`clk`域。
   * **正常处理模式 (Normal Mode):** 在此模式下，模块选择来自 **算法模块 (Algorithm Module)** 的输出。这是系统默认的工作状态，所有经过图像增强算法处理后的视频数据将通过此路径输出。
   * **调试模式 (Debug Mode):** 当 REGF 寄存器中的 DEB_MODE 被激活时，系统进入调试模式。此时，该模块会选择来自 **测试视频 (Test Video)**模块的输出。测试视频模块可以生成固定的图像模式（如彩条、纯色或棋盘格），用于验证显示链路的完整性、时序和基本颜色表现，而无需依赖外部视频输入。

## 2.2 `pclk`时钟域（像素处理域）

该区域在`pclk`时钟驱动下，负责对视频流进行实时处理和输出，`pclk`的频率与视频的像素速率同步。

1. 输入视频接口 (Input Video Interface)

   作为外部真实视频流的入口，该接口接收来自上游视频源的原始像素数据。

2. 算法模块 (Algorithm Module)

   这是画质增强系统的核心处理单元。它是一个大型的流水线结构，接收来自“输入视频接口”的像素数据，并依次通过以下一系列串行处理的算法，完成画质增强：

*   **自适应饱和度增强**
    *   **饱和度增强:** 提升画面的色彩鲜艳度。
    *   **肤色保真:** 在增强饱和度的同时，保护人脸肤色，避免失真。
*   **自适应对比度增强**
    *   **CLAHE算法:** 增强图像暗部区域的细节。
    *   **灰阶保护:** 识别并保护大面积纯色区域，缓解对比度增强引入色阶断裂的问题。
*   **图像清晰度提升:** 增强图像的边缘和细节，使画面更清晰。
*   **引导滤波 :** 专门针对天空等大面积渐变区域进行保护，防止色阶断裂。
*   **护眼色温调节:** 调整色温，降低蓝光，提供更舒适的观看体验。

3. 输出视频接口 (Output Video Interface)

   处理完成的视频数据从此接口输出，送往显示设备或下一级处理单元。 

## 2.3 代码层级

该 IP 的代码层级结构如下：

*   **`pqe_top` (顶层模块)**
    这是整个 IP 的最顶层，负责例化和连接所有的子模块，并对外提供硬件接口（如 AHB、中断、视频输入/输出、时钟及复位信号）。

    *   **`regf` (寄存器列表模块)**
        *   **功能**: 作为 IP 的控制中心，提供 AHB 接口供软件配置参数、启动模块和读取状态。它负责将配置信号同步并分发给 `pclk` 域的各个算法模块。
        *   **所属时钟域**: `clk`
    *   **`tpg` (测试视频模块 / Test Pattern Generator)**
        *   **功能**: 用于生成内部纯色测试视频码流，作为视频通路的输入源之一，便于调试和验证。
        *   **所属时钟域**: `clk`
    *   **`algorithm_module` (算法总模块)**
        *   **功能**: 这是视频处理的核心，它接收来自外部的视频输入，并包含了所有图像质量增强的算法子模块。
        *   **所属时钟域**: `pclk`
        *   该模块内部又包含以下并行的处理模块：
            *   **`ace` (自适应对比度增强模块)**
                *   `clahe` (CLAHE算法)
                *   `flat_region_protection` (灰阶保护)
            *   **`ase` (自适应饱和度与肤色保真模块)**
                *   `saturation_enhancement` (饱和度增强)
                *   `skintone_fidelity` (肤色保真)
            *   `guided_filter` (引导滤波)
            *   `sharpness_clarity_enhancement` (锐度清晰度增强)
            *   `eyecare_cct_adjustment` (护眼+色温调节)
    *   **`video_mux` (切换视频源模块)**
        *   **功能**: 这是一个输出选择器，它接收来自 `algorithm_module` 处理后的视频和来自 `tpg` 的测试视频（跨时钟域同步后），根据寄存器配置选择其中之一输出到 `输出视频接口`。这通常用于实现 bypass 功能或显示测试画面。
        *   **所属时钟域**: `pclk` 

<div STYLE="page-break-after: always;"></div>

# 3 接口列表

| 名称   | IO   | 位宽 | 时钟域 | 连接         | 描述               |
| ------ | ---- | ---- | ------ | ------------ | ------------------ |
| clk    | In   | 1    | -      | 系统时钟     | clk时钟            |
| rstn   | In   | 1    | clk    | -            | clk时钟复位        |
| pclk   | In   | 1    | -      | 像素时钟     | pclk时钟           |
| prstn  | In   | 1    | clk    | -            | pclk时钟复位       |
| haddr  | In   | 32   | clk    | AHB接口      | 地址总线           |
| htrans | In   | 2    | clk    | AHB接口      | 传输类型           |
| hsel   | In   | 1    | clk    | AHB接口      | 从设备选择         |
| hwrite | In   | 1    | clk    | AHB接口      | 传输方向           |
| hsize  | In   | 3    | clk    | AHB接口      | 传输大小           |
| hstrb  | In   | 4    | clk    | AHB接口      | 字节选通           |
| hwdata | In   | 32   | clk    | AHB接口      | 写数据总线         |
| hrdata | out  | 32   | clk    | AHB接口      | 读数据总线         |
| hready | Out  | 1    | clk    | AHB接口      | 传输完成           |
| hresp  | In   | 2    | clk    | AHB接口      | 传输响应           |
| intr   | Out  | 1    | pclk   | 中断接口     | 发生中断。高有效   |
| ide    | In   | 1    | pclk   | 输入视频接口 | 输入像素使能       |
| ihs    | In   | 1    | pclk   | 输入视频接口 | 输入行同步         |
| ivs    | In   | 1    | pclk   | 输入视频接口 | 输入场同步         |
| ick    | In   | 1    | pclk   | 输入视频接口 | 输入像素时钟       |
| ida    | In   | 8x30 | pclk   | 输入视频接口 | 输入像素（8xLANE） |
| ode    | Out  | 1    | pclk   | 输出视频接口 | 输出像素使能       |
| ohs    | Out  | 1    | pclk   | 输出视频接口 | 输出行同步         |
| ovs    | Out  | 1    | pclk   | 输出视频接口 | 输出场同步         |
| ock    | Out  | 1    | pclk   | 输出视频接口 | 输出像素时钟       |
| oda    | Out  | 8x30 | pclk   | 输出视频接口 | 输出像素（8xLANE） |

<div STYLE="page-break-after: always;"></div>

# 4 待讨论问题

1.  **问题：是否需要支持大于4K分辨率的视频输入？**
    *   **背景与影响：** 当前设计目标是支持到4K分辨率。若要支持大于4K（例如5K、8K）的分辨率，将需要更大容量的片上存储（SRAM）用于行缓冲等处理，这会显著增加芯片面积和成本。此外，需要确认芯片规划的外部视频接口（如MIPI、DP）是否有足够的带宽来支持更高分辨率的传输。
    *   **待明确：** 我们是否需要将支持范围扩展到4K以上？如果需要，具体的目标分辨率是多少？对应的面积和成本预算是否可以接受？
2.  **问题：是否需要支持16 LANE的视频流输入？**
    *   **背景与影响：** 当前PQE支持2、4、8 LANE视频输入。支持16 LANE需要将内部数据处理位宽加倍，实现更高的数据并行度，这将直接增加逻辑面积（如需要更多的SRAM用于缓冲，更多的乘法器/除法器用于并行计算）。同时，需要确认SoC上游是否能提供16 LANE的视频接口与PQE对接。
    *   **待明确：** 16 LANE输入是否为刚需？如果是，我们是否已为相关的面积增长以及对外部接口的依赖做好了准备？
3.  **问题：是否支持大于160Hz的视频流输入？**
    *   **背景与影响：** 支持高于160Hz的帧率要求PQE工作在更高的时钟频率下，这可能增加物理设计时的时序收敛（Timing Closure）难度，同时也会增加功耗。此外，需要确认芯片规划的外部视频接口（如MIPI、DP）是否有足够的带宽来支持更高分辨率的传输。
    *   **待明确：** 我们必须支持的最高帧率是多少？
5.  **问题：不支持视频切片（Slicing）功能的影响？**
    *   **背景与影响：** PQE被设计为处理完整的视频帧，不支持切片输入。这意味着如果视频源（如显示控制器）以切片方式提供视频流，必须由上游模块先将切片拼接成完整的一帧，再送入PQE。这对SoC的系统架构提出了明确要求。
    *   **待明确：** 这个限制对于目标系统架构是否可以接受？
6.  **问题：不支持检测视频链路稳定性的影响？**
    *   **背景与影响：** PQE模块本身不包含检测输入视频链路稳定性的逻辑。当前的设计假设是：由外部控制器管理视频链路，确保其稳定后，再解除PQE的复位使其开始工作。不稳定的链路信号可能导致PQE输出视觉伪影或产生内部错误。
    *   **待明确：** 这个假设在目标系统中是否成立？完全依赖外部控制器来监控链路稳定性是否足够？或者PQE是否应包含一些基本的稳定性检查机制（如监控同步信号的连续性）来主动防止错误？
7.  **问题：是否对PQE的配置时间有明确要求？**
    *   **背景与影响：** PQE上电后需要通过AHB总线进行初始化。肤色保真功能需要初始化一个512深度的SRAM。过长的初始化时间可能会延迟开机后第一帧画面的显示。
    *   **待明确：** 对于PQE从上电到完全配置好并准备处理视频流的最长可接受时间是否有明确要求（例如，毫秒级别）？这将影响AHB接口的设计以及初始化序列的策略。
8.  **问题：关于最终硬件面积的评估与资源需求**
    *   **背景与影响：** 根据初步评估，若基于当前已确定的最高规格（4K, 10bit, 8-lane），并考虑潜在的160Hz帧率目标，硬件面积相比最初基于 `2880x1260, 60Hz, 8-bit` 的评估结果，预计将增加一倍左右。这可能超出项目原定的成本预算。
    *   **待明确：** 
        1.  首先，希望贵方能评估并告知，在当前规格下，预估的面积增长是否在可接受的预算范围内。
        2.  为了协助我们进行更精确的面积评估以支持最终决策，我们希望能获得必要的资源支持。具体来说，我们希望能申请到一个具备基础EDA工具（如DC, VCS, Verdi）的内部账号，并获取本次合作项目的工艺库与SRAM Compiler。如果能提供一些用于快速评估的示例脚本，将会极大地帮助我们提高效率。不知这些资源大约何时可以提供？
