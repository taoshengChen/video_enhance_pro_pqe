# EPCTA

| 项目 | PQE芯片       |
| -- | ----------- |
| 芯片 |             |
| 版本 | V1.0        |
| 作者 | 张灿澄         |
| 出版 | FPGA锐智团队    |
| 日期 | 2025年11月17日 |

## 1 概述

### 1.1 模块功能

本模块通过动态调整输入视频RGB通道数据实现对蓝光的抑制/增强，以达到护眼和色温调节的功能。模块支持参数配置，在降低高能蓝光影响的同时保持画面色彩平衡。

### 1.2 模块定位

![](image/image_QL3w5yyaNG.png)

图1.1 护眼色温调节模块定位

- EPCTA模块全称Eye protection color temperature adjustment，意为护眼色温调节。
- 模块位于算法模块Algo\_top最末尾的位置。

### 1.3 模块特性

- **支持多种色深格式：** 算法模块兼容 **8-bit** 和 **10-bit** 两种视频色深输入。
- **支持多通道并行处理：** 可配置并行处理 **2、4、8** 个视频通道（LANE）的数据，适应不同吞吐率需求。
  - **动态时钟门控：** 为实现功耗最优化，当输入视频流的 LANE 数小于硬件支持的最大数量时，系统能够自动关闭未使用通道的时钟。
- **支持旁路直通模式：** 模块计算过程可被 **完全旁路**，实现视频数据的无损透传。
- **支持分屏对比功能：** 内置用于调试和效果演示的分屏对比功能，可实时、直观地评估算法效果。
  - **分屏规格：** 左半屏为算法处理后的数据，右半屏为原始直通数据。
- **支持参数在线配置：** 模块开放 **5个** 算法相关参数供在线配置，通过调节参数可灵活实现护眼模式或冷暖色调调节。
  - **阈值参数 (x0, x1)：** 将输入图像亮度范围划分为暗部、中间调和亮部三个区间。
  - **偏移量参数 (b)：** 用于直接调整亮部区域的强度。
  - **增益参数 (k1, k2)：** 分别用于调整 R、B 通道在中间调区域的对比度/增益。
- **时钟频率：** 模块运行时钟频率最高支持 **xxMHz**。
- **模块延迟：** 经过模块算法处理，数据输出延迟为 **3个** 像素时钟（注：具体以接口时序图为准）。

### 1.4 设计目标

1. **预期面积：** 16个10bit*12bit乘法器，3000*8与非门。
2. **预期时序：**支持最高频率**xxMHz**，无时序违例。

## 2 接口定义

### 2.1 接口列表

| 名称            | IO  | 位宽 | 时钟域  | 连接          | 描述                   |
| ------------- | --- | -- | ---- | ----------- | -------------------- |
| clk1          | In  | 1  | pclk | Algo\\\_top | lane1-lane2像素时钟      |
| clk2          | In  | 1  | pclk | Algo\\\_top | lane3-lane4像素时钟      |
| clk3          | In  | 1  | pclk | Algo\\\_top | lane5-lane8像素时钟      |
| rst\\\_n      | In  | 1  | pclk | Algo\\\_top | 复位，低有效               |
| pixel\\\_bits | In  |    | pclk | Algo\\\_top |                      |
| lane\\\_num   | In  |    | pclk | Algo\\\_top |                      |
| para\\\_b     | In  | 10 | pclk | Algo\\\_top | 偏移量参数b               |
| para\\\_x0    | In  | 10 | pclk | Algo\\\_top | 左阈值坐标参数x0            |
| para\\\_x1    | In  | 10 | pclk | Algo\\\_top | 右阈值坐标参数x1            |
| para\\\_k1    | In  | 12 | pclk | Algo\\\_top | B分量对应增益参数k1          |
| para\\\_k2    | In  | 12 | pclk | Algo\\\_top | R分量对应增益参数k2          |
| r\\\_in       | In  | 80 | pclk | Algo\\\_top | R通路输入，8LANE\\\*10bit |
| g\\\_in       | In  | 80 | pclk | Algo\\\_top | G通路输入，8LANE\\\*10bit |
| b\\\_in       | In  | 80 | pclk | Algo\\\_top | B通路输入，8LANE\\\*10bit |
| de\\\_in      | In  | 1  | pclk | Algo\\\_top | 像素输入有效信号             |
| r\\\_out      | Out | 80 | pclk | Algo\\\_top | R通路输出，8LANE\\\*10bit |
| g\\\_out      | Out | 80 | pclk | Algo\\\_top | G通路输出，8LANE\\\*10bit |
| b\\\_out      | Out | 80 | pclk | Algo\\\_top | B通路输出，8LANE\\\*10bit |
| de\\\_out     | In  | 1  | pclk | Algo\\\_top | 像素输出有效信号             |

### 2.2 接口时序图

![](image/image_cVQYZdUmoJ.png)

图2.1 护眼色温调节模块接口时序

> 这个波形主要描述接口数据流，de\_in跟随像素输入r\_in，g\_in和b\_in指示有效性，经过**3个**像素时钟得到输出r\_out，g\_out以及b\_out，伴随de\_out指示有效性

# 3 寄存器和存储器

### 3.1 寄存器映射表

#### 3.1.1 寄存器摘要

无

#### 3.1.2 寄存器描述

无

#### 3.2 存储器映射区间

无

## 4 详细设计

![](image/image_UFHYLAOw2N.png)

图4.1 护眼色温算法曲线

护眼色温算法曲线如图4.1所示。算法根据输入像素的亮度值，将其划分为三个区间进行差异化处理：

- \*\*暗部区间 \*\*$[0, para\_x0]$：保持像素原值不变，避免影响暗部细节。
- \*\*中间调区间 \*\*$(para\_x0, para\_x1)$：该区间是蓝光分量的主要分布区域。B通道执行曲线②计算，R通道执行曲线①计算。通过调节该区间的输出值，实现色温调节或蓝光抑制的核心效果。
- \*\*亮部区间 \*\*$[para\_x1, Max\_Value]$：B通道执行曲线③计算，R通道执行曲线④计算，确保亮度过渡平滑自然。

### 4.1 EPCTA\_computation模块

#### 4.1.1 EPCTA\_computation模块功能描述

根据图4.1划分的三个区间进行计算，具体为下式(1)与式(2)：

![](image/image_MlDJpMg12w.png)

#### 4.1.2 EPCTA\_computation模块接口

| 名称           | IO  | 位宽 | 时钟域  | 连接           | 描述                                             |
| ------------ | --- | -- | ---- | ------------ | ---------------------------------------------- |
| clk          | In  | 1  | pclk | EPCTA\\\_top | 像素时钟                                           |
| rst\\\_n     | In  | 1  | pclk | EPCTA\\\_top | 复位，低有效                                         |
| pixel\\\_in  | In  | 10 | pclk | EPCTA\\\_top | 像素输入                                           |
| para\\\_b    | In  | 10 | pclk | EPCTA\\\_top | 偏移量参数b                                         |
| para\\\_x0   | In  | 10 | pclk | EPCTA\\\_top | 左阈值坐标参数x0                                      |
| para\\\_x1   | In  | 10 | pclk | EPCTA\\\_top | 右阈值坐标参数x1                                      |
| para\\\_k    | In  | 10 | pclk | EPCTA\\\_top | 增益参数k                                          |
| para\\\_bk   | In  | 10 | pclk | EPCTA\\\_top | 实际偏移量参数  对R通道：para\\\_b\\\*0.3  对B通道：para\\\_b |
| pixel\\\_out | Out | 10 | pclk | EPCTA\\\_top | 像素输出                                           |

#### 4.1.3 EPCTA\_computation模块详细设计

EPCTA\_computation模块电路结构如图4.2所示，主要包含**区间比较逻辑**、**算术运算单元**和**输出限幅**三个部分。

![](image/image_txIlOO6WkS.png)

图4.2 EPCTA\_computation电路图

1. **区间比较逻辑 (Range Comparator)**：
   - 输入像素 `pixel_in` 同时送入两个比较器，分别与阈值参数 `para_x0` 和 `para_x1` 进行比较。
   - 比较结果生成区间指示信号，用于判定当前像素属于暗部、中间调还是亮部区间。
2. **算术运算单元 (Arithmetic Unit)**：
   - **中间调计算**：根据公式 (1) 和 (2)，计算中间调区间的像素值。该路径通常包含减法器（`pixel_in - para_x0`）、乘法器（乘以增益 `para_k`）以及加法器（加上基准值），实现线性变换。
   - **亮部计算**：计算亮部区间的像素值，通常涉及减法或加法运算（如 `pixel_in - para_bk`），以实现亮度的整体偏移调整；此时乘法操作数被选择为0。
   - **暗部路径**：直接通过原始数据，“不进行算术运算”（此时乘法操作数被选择为0，加法操作数被选择为0）。
3. **输出限幅 (Output Clamping)**：
   - 为了防止数据溢出，运算结果在输出前会经过饱和截断处理 (Clamping)，确保输出值在有效位宽范围内（如 0\~1023）。
4. **流水线设计**：
   - 为了满足高频时序要求，模块内部设计了流水线寄存器（Pipeline Registers）。输入数据、中间计算结果和控制信号均经过打拍处理，确保关键路径的时序收敛。

## 5 时序要求

***关键时序路径：*** *识别模块内部的潜在关键路径（如长组合逻辑链、跨模块路径） \*\*。*

***时钟约束：*** *主时钟频率要求，衍生时钟关系（同源、频率比、相位） \*\*。*

***输入/输出延迟约束：*** *根据系统要求或接口时序图，定义输入相对于时钟的* *set\_input\_delay* *和输出相对于时钟的* *set\_output\_delay*。在文档中明确这些约束值或要求范围。

***多周期路径：*** *明确需要设置时序例外（False* *Path, Multicycle* *Path）的信号或路径及其原因（如不同时钟域之间未同步的信号、逻辑上不需要单周期完成的路径）*

1. 关键路径：无
2. 时序约束：
3. 输入输出延迟约束：
4. 多周期路径：无
